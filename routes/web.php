<?php

use Illuminate\Support\Facades\Route;
use Illuminate\Support\Facades\Artisan;

// Admin Controllers
use App\Http\Controllers\Admin\Auth\LoginController as AdminLoginController;
use App\Http\Controllers\Admin\AdminSecurityLogController;
use App\Http\Controllers\Admin\ExamController;
use App\Http\Controllers\Admin\ExamScheduleController;
use App\Http\Controllers\Admin\QuestionController;
use App\Http\Controllers\Admin\RequestController as AdminRequestController;
use App\Http\Controllers\Admin\StaffRequestController;
use App\Http\Controllers\Admin\StudentController;

// Student Controllers
use App\Http\Controllers\Student\Auth\LoginController as StudentLoginController;
use App\Http\Controllers\Student\DashboardController as StudentDashboardController;

// SuperAdmin Controllers
use App\Http\Controllers\SuperAdmin\AdminController;
use App\Http\Controllers\SuperAdmin\AdminRequestController as SuperAdminAdminRequestController;
use App\Http\Controllers\SuperAdmin\Auth\LoginController as SuperAdminLoginController;
use App\Http\Controllers\SuperAdmin\DashboardController as SuperAdminDashboardController;
use App\Http\Controllers\SuperAdmin\SchoolController;
use App\Http\Controllers\SuperAdmin\SecurityLogController;
use App\Http\Controllers\SuperAdmin\StaffRequestController as SuperAdminStaffRequestController;
use App\Http\Controllers\SuperAdmin\StudentController as SuperAdminStudentController;

// System Utility Routes
Route::get('/clear-cache', function () {
    if (!app()->environment(['local', 'staging', 'production'])) {
        abort(403, 'Unauthorized.');
    }
    Artisan::call('cache:clear');
    Artisan::call('config:clear');
    Artisan::call('route:clear');
    Artisan::call('view:clear');
    return "All caches cleared successfully!";
})->name('clear.cache');

Route::view('/', 'welcome')->name('welcome');

// =====================
// SuperAdmin Routes
// =====================
Route::prefix('superadmin')->name('superadmin.')->group(function () {

    // -------- Guest SuperAdmin Routes --------
    Route::middleware('guest:superadmin')->group(function () {
        Route::get('login', [SuperAdminLoginController::class, 'showLoginForm'])->name('login');
        Route::post('login', [SuperAdminLoginController::class, 'login'])->name('login.submit');
        Route::get('login-otp', [SuperAdminLoginController::class, 'showOtpForm'])->name('otp.form');
        Route::post('login-otp', [SuperAdminLoginController::class, 'sendOtp'])->name('otp.send');
        Route::get('verify-otp', [SuperAdminLoginController::class, 'showVerifyOtpForm'])->name('otp.verify.form');
        Route::post('verify-otp', [SuperAdminLoginController::class, 'verifyOtp'])->name('otp.verify');
    });

    // -------- Authenticated SuperAdmin Routes --------
    Route::middleware('auth:superadmin')->group(function () {

        // Session
        Route::post('logout', [SuperAdminLoginController::class, 'logout'])->name('logout');
        Route::get('dashboard', [SuperAdminDashboardController::class, 'index'])->name('dashboard');

        // Security Logs
        Route::get('security-logs', [SecurityLogController::class, 'index'])->name('security.logs');
        Route::get('security-logs/export', [SecurityLogController::class, 'export'])->name('security.logs.export');

        // School Management
        Route::prefix('schools')->name('schools.')->group(function () {
            Route::get('/', [SchoolController::class, 'index'])->name('index');
            Route::get('suspension', [SchoolController::class, 'suspension'])->name('suspension');
            Route::post('{school}/toggle-suspension', [SchoolController::class, 'toggleSuspension'])->name('toggle-suspension');
            Route::get('create', [SchoolController::class, 'create'])->name('create');
            Route::post('store', [SchoolController::class, 'store'])->name('store');
            Route::get('{school}/create-admin', [SchoolController::class, 'createAdmin'])->name('create-admin');
            Route::post('{school}/admin-store', [AdminController::class, 'storeSchoolAdmin'])->name('admin-store');
            Route::get('{school}/edit', [SchoolController::class, 'edit'])->name('edit');
            Route::put('{school}', [SchoolController::class, 'update'])->name('update');
            Route::get('{school}/edit-admin', [SchoolController::class, 'editAdmin'])->name('edit-admin');
            Route::put('{school}/admin-update/{admin}', [AdminController::class, 'updateSchoolAdmin'])->name('admin-update');
        });

        // Admin Management
        Route::prefix('admins')->name('admins.')->group(function () {
            Route::get('/', [AdminController::class, 'index'])->name('index');
            Route::get('create', [AdminController::class, 'create'])->name('create');
            Route::post('/', [AdminController::class, 'store'])->name('store');
            Route::get('{admin}/edit', [AdminController::class, 'edit'])->name('edit');
            Route::put('{admin}', [AdminController::class, 'update'])->name('update');
        });

        // Staff Requests Management
        Route::prefix('staff-requests')->name('staff-requests.')->group(function () {
            Route::get('/', [SuperAdminStaffRequestController::class, 'index'])->name('index');
            Route::get('{staffRequest}', [SuperAdminStaffRequestController::class, 'show'])->name('show');
            Route::post('{staffRequest}/approve', [SuperAdminStaffRequestController::class, 'approve'])->name('approve');
            Route::post('{staffRequest}/reject', [SuperAdminStaffRequestController::class, 'reject'])->name('reject');
        });

        // Admin Requests
        Route::prefix('admin-requests')->name('admin-requests.')->group(function () {
            Route::get('/', [SuperAdminAdminRequestController::class, 'index'])->name('index');
            Route::post('{adminRequest}/action', [SuperAdminAdminRequestController::class, 'action'])->name('action');
        });

        // Student Management
        Route::prefix('students')->name('students.')->group(function () {
            Route::get('/', [SuperAdminStudentController::class, 'index'])->name('index');
            Route::get('{id}', [SuperAdminStudentController::class, 'show'])->name('show');
            Route::post('{id}/status', [SuperAdminStudentController::class, 'toggleStatus'])->name('toggle-status');
            Route::post('{id}/transfer', [SuperAdminStudentController::class, 'transfer'])->name('transfer');
            Route::post('{id}/reset-exam', [SuperAdminStudentController::class, 'resetExam'])->name('reset-exam');
            Route::post('bulk-action', [SuperAdminStudentController::class, 'bulkAction'])->name('bulk-action');
        });
    });
});

// =====================
// Admin Routes
// =====================
Route::prefix('admin')->name('admin.')->group(function () {

    // -------- Login & Security --------
    Route::get('login', [AdminLoginController::class, 'showLoginForm'])->name('login');
    Route::post('login', [AdminLoginController::class, 'login'])->name('login.submit');
    Route::post('send-otp', [AdminLoginController::class, 'sendOtp'])->name('send.otp');
    Route::get('verify-otp', [AdminLoginController::class, 'otpForm'])->name('otp.verify.form');
    Route::post('verify-otp', [AdminLoginController::class, 'verifyOtp'])->name('verify.otp');
    Route::get('security-logs', [AdminSecurityLogController::class, 'index'])->name('security.logs');
    Route::get('security-logs/export', [AdminSecurityLogController::class, 'export'])->name('security.logs.export');

    // -------- Authenticated Admin Area --------
    Route::middleware(['auth:admin', \App\Http\Middleware\CheckSchoolActive::class . ':admin'])->group(function () {

        Route::view('dashboard', 'admin.dashboard')->name('dashboard');
        Route::post('logout', [AdminLoginController::class, 'logout'])->name('logout');

        // Staff Creation Wizard
        Route::prefix('staff/create')->name('staff.create.')->group(function () {
            Route::get('step-1', [StaffRequestController::class, 'step1'])->name('step1');
            Route::post('step-1', [StaffRequestController::class, 'postStep1'])->name('postStep1');
            Route::get('step-2', [StaffRequestController::class, 'step2'])->name('step2');
            Route::post('step-2', [StaffRequestController::class, 'postStep2'])->name('postStep2');
            Route::get('step-3', [StaffRequestController::class, 'step3'])->name('step3');
            Route::post('step-3', [StaffRequestController::class, 'postStep3'])->name('postStep3');
            Route::get('review', [StaffRequestController::class, 'review'])->name('review');
            Route::post('submit', [StaffRequestController::class, 'submit'])->name('submit');
        });

        // Staff Requests
        Route::get('requests/staff/create', [AdminRequestController::class, 'createStaffRequest'])->name('requests.staff.create');
        Route::post('requests/staff', [AdminRequestController::class, 'storeStaffRequest'])->name('requests.staff.store');

        // Student Management
        Route::get('students/bulk-sample', [StudentController::class, 'downloadSample'])->name('students.bulk_sample');
        Route::get('students/bulk-create', [StudentController::class, 'bulkCreate'])->name('students.bulk_create');
        Route::post('students/bulk-store', [StudentController::class, 'bulkStore'])->name('students.bulk_store');
        Route::resource('students', StudentController::class);
    });

    // -------- Question Management --------
    Route::prefix('questions')->name('questions.')->group(function () {
        Route::get('/', [QuestionController::class, 'index'])->name('index');
        Route::get('create', [QuestionController::class, 'create'])->name('create');
        Route::post('/', [QuestionController::class, 'store'])->name('store');
    });

    // -------- Exam Management --------
    Route::prefix('exams')->name('exams.')->group(function () {
        Route::get('/', [ExamController::class, 'index'])->name('index');
        Route::get('create', [ExamController::class, 'create'])->name('create');
        Route::post('/', [ExamController::class, 'store'])->name('store');
        Route::get('{exam}/questions', [ExamController::class, 'editQuestions'])->name('edit-questions');
        Route::post('{exam}/questions', [ExamController::class, 'attachQuestions'])->name('attach-questions');
        Route::post('{exam}/publish', [ExamController::class, 'publish'])->name('publish');
        Route::post('{exam}/close', [ExamController::class, 'close'])->name('close');
    });

    // Exam Scheduling
    Route::get('exams/{exam}/schedule', [ExamScheduleController::class, 'create'])->name('exams.schedule');
    Route::post('exams/{exam}/schedule', [ExamScheduleController::class, 'store'])->name('exams.schedule.store');
});

// =====================
// Student Routes
// =====================
Route::prefix('student')->name('student.')->group(function () {

    Route::middleware('guest')->group(function () {
        Route::get('login', [StudentLoginController::class, 'showLoginForm'])->name('login');
        Route::post('login', [StudentLoginController::class, 'login'])->name('login.submit');
    });

    Route::middleware(['auth', \App\Http\Middleware\CheckSchoolActive::class . ':web'])->group(function () {
        Route::get('dashboard', [StudentDashboardController::class, 'index'])->name('dashboard');
        Route::post('logout', [StudentLoginController::class, 'logout'])->name('logout');
        Route::view('profile', 'student.profile')->name('profile'); // Placeholder
    });
});
