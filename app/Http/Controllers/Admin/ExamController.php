<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Models\Exam;
use App\Models\Question;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;

class ExamController extends Controller
{
    public function index()
    {
        $admin = auth('admin')->user();

        $exams = Exam::with('schedule')
            ->where('school_id', $admin->school_id)
            ->latest()
            ->paginate(20);

        return view('admin.exams.index', compact('exams'));
    }

    public function create()
    {
        return view('admin.exams.create');
    }

    public function store(Request $request)
    {
        $request->validate([
            'title' => 'required',
            'class' => 'required',
            'subject' => 'required',
            'academic_session' => 'required',
            'exam_type' => 'required',
            'duration_minutes' => 'required|integer|min:1',
        ]);

        $admin = auth('admin')->user();

        $exam = Exam::create([
            'school_id' => $admin->school_id,
            'created_by' => $admin->id,
            'title' => $request->title,
            'class' => $request->class,
            'subject' => $request->subject,
            'academic_session' => $request->academic_session,
            'exam_type' => $request->exam_type,
            'duration_minutes' => $request->duration_minutes,
            'pass_marks' => $request->pass_marks,
            'negative_marking' => $request->negative_marking ?? 0,
            'negative_marks' => $request->negative_marks ?? 0,
            'shuffle_questions' => $request->shuffle_questions ?? 0,
            'shuffle_options' => $request->shuffle_options ?? 0,
            'instructions' => json_encode(
                array_values(array_filter($request->instructions ?? []))
            ),
            'status' => 'draft'
        ]);

        return redirect()->route('admin.exams.questions', $exam->id);
    }

    // professional attach screen
    public function questions($id)
    {
        $admin = auth('admin')->user();

        $exam = Exam::where('school_id', $admin->school_id)
            ->findOrFail($id);

        $questions = Question::where('school_id', $admin->school_id)
            ->where('class', $exam->class)
            ->get();

        $attached = $exam->selected_questions ?? [];

        return view('admin.exams.questions', compact('exam', 'questions', 'attached'));
    }


    public function attachQuestions(Request $request, $id)
    {
        $admin = auth('admin')->user();

        $exam = Exam::where('school_id', $admin->school_id)
            ->findOrFail($id);

        $request->validate([
            'questions' => 'required|array'
        ]);

        $questions = Question::whereIn('id', $request->questions)
            ->where('school_id', $admin->school_id)
            ->get();

        $exam->update([
            'selected_questions' => $questions->pluck('id')->values()->toArray(),
            'total_marks' => $questions->sum('marks')
        ]);

        return redirect()->route('admin.exams.index');
    }




    public function publish($id)
    {
        $admin = auth('admin')->user();

        $exam = Exam::where('school_id', $admin->school_id)
            ->findOrFail($id);

        if (empty($exam->selected_questions) || count($exam->selected_questions) === 0) {
            return back()->with('error', 'Attach questions first');
        }

        if (!$exam->schedule) {
            return back()->with('error', 'Schedule exam first');
        }

        $exam->update([
            'status' => 'published'
        ]);

        return back();
    }

    public function close($id)
    {
        $admin = auth('admin')->user();

        $exam = Exam::where('school_id', $admin->school_id)->findOrFail($id);

        $exam->update(['status' => 'closed']);

        return back();
    }

    public function show(Request $request, $id)
    {
        $admin = auth('admin')->user();

        $exam = Exam::with('schedule')
            ->where('school_id', $admin->school_id)
            ->findOrFail($id);

        // already array because of cast
        $ids = $exam->selected_questions ?? [];

        $questions = collect();

        if (!empty($ids)) {

            // keep same order as selected in exam
            $idsString = implode(',', $ids);

            $questions = Question::whereIn('id', $ids)
                ->orderByRaw("FIELD(id, $idsString)")
                ->get();
        }

        // since you removed sets & pivot
        $set = 'A';
        $sets = collect(['A']);

        return view('admin.exams.show', compact(
            'exam',
            'questions',
            'set',
            'sets'
        ));
    }

    public function edit($id)
    {
        $admin = auth('admin')->user();

        $exam = Exam::where('school_id', $admin->school_id)
            ->findOrFail($id);

        if ($exam->status === 'closed') {
            return redirect()
                ->route('admin.exams.index')
                ->with('error', 'Closed exam cannot be edited.');
        }

        return view('admin.exams.edit', compact('exam'));
    }

    public function update(Request $request, $id)
    {
        $admin = auth('admin')->user();

        $exam = Exam::where('school_id', $admin->school_id)
            ->findOrFail($id);

        if ($exam->status === 'closed') {
            return redirect()
                ->route('admin.exams.index')
                ->with('error', 'Closed exam cannot be edited.');
        }

        $request->validate([
            'title' => 'required|string|max:255',
            'academic_session' => 'required|string',
            'exam_type' => 'required|string',
            'duration_minutes' => 'required|integer|min:1',
            'pass_marks' => 'nullable|integer|min:0',
            'negative_marks' => 'nullable|numeric|min:0',
        ]);

        $exam->update([
            'title' => $request->title,
            'academic_session' => $request->academic_session,
            'exam_type' => $request->exam_type,
            'duration_minutes' => $request->duration_minutes,
            'pass_marks' => $request->pass_marks ?? 0,

            'negative_marking' => $request->has('negative_marking'),
            'negative_marks' => $request->negative_marks ?? 0,
            'shuffle_questions' => $request->has('shuffle_questions'),
            'shuffle_options' => $request->has('shuffle_options'),

            'instructions' => json_encode(
                array_values(array_filter($request->instructions ?? []))
            ),
        ]);

        return redirect()
            ->route('admin.exams.show', $exam->id)
            ->with('success', 'Exam updated successfully.');
    }




}
